<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>

<div id="container" style="width:100%; height:400px;"></div>

<script>

var gSensors;

// function generateGraph(selectIn)
// {
//   var idx = selectIn.selectedIndex;
//   var sensor = gSensors[idx-1];

//   if (typeof sensor != "undefined")
//   {
//     drawGraph(sensor.controller_id, sensor.node_id, sensor.sensor_id)
// ;  }
// }

function addToGraph(selectIn)
{
  var idx = selectIn.selectedIndex;
  var sensor = gSensors[idx-1];
  if (typeof sensor != "undefined")
  {
    addSensor(sensor.controller_id, sensor.node_id, sensor.sensor_id)
;  }
}   

function addMultipleToGraph()
{
  for (i in gSensors)
  {
    sensor = gSensors[i];
    if (typeof sensor != "undefined")
    {
      addSensor(sensor.controller_id, sensor.node_id, sensor.sensor_id);
    }
  }
}

function populateSensors(selectIn, selectOut)
{
  var idx = selectIn.selectedIndex;
  var val = selectIn[idx].text;
  var par = document.forms["sensorType"];
  var parelmts = par.elements;
  var sensorType = val;
  {
    $.get("http://localhost:8000/api/sensors/" + sensorType, 
      function(data, status){
            fillSelect(data, selectOut)
    });
  }

  selectOut.selectedIndex = 0;
}

function fillSelect(jsonReply, selectOut)
{
  gSensors = jsonReply;
  var length = gSensors.length;

  selectOut.length = length + 1

  for (i= 0; i < length; i++)
  {
    selectOut[i+1].text = (gSensors[i].name);
  }
}

function formatData(serializer_data) {
    formatted_data = [];
    $.each(serializer_data, function(key, value) {
        var date = new Date(value.created);
        formatted_data.push([date.getTime(), parseFloat(value.payload)]);
    }); 
    return formatted_data;
}

function addSensor(controller, node, sensor) {
    var chart = $('#container').highcharts();

    $.getJSON( "http://localhost:8000/api/controllers/" + controller + "/nodes/" + node + "/sensors/" +
            sensor, function( sensorInfo ) {

        // check to avoid adding a series multiple times
        if (chart.get(sensorInfo["sensor_id"])) return;

        $.getJSON( "http://localhost:8000/api/controllers/" + controller + "/nodes/" + node + "/sensors/" +
            sensor + "/data/", function( data ) {
            var formatted_data = formatData(data);

            chart.addSeries({
                yAxis: sensorInfo["sensor_type"],
                name: sensorInfo["name"],
                id: sensorInfo["sensor_id"],
                data: formatted_data,
            });
        }); 
    });
}

// set initial chart options
function initializeGraph() {
    // display times in local timezone
    Highcharts.setOptions({
        global: {
            useUTC: false
        }
    })

    $('#container').highcharts({
        xAxis: {
            type: 'datetime'
        },

        yAxis: [{
            title: {
                text: "CO2 ppm"
            },
            id: "co2",
            opposite: false,
        }, {
            title: {
                text: "Temperature Â°C"
            },
            id: "temperature",
            opposite: true,
        }, {    
            title: {
                text: "Humidity %"
            },
            id: "humidity",
            opposite: true,         
        }],

        plotOptions: {
            series: {
                marker: {
                    enabled: false
                },
                lineWidth: 3
            }
        },
    });
}

$(function () {
    $('#buttonGraph').click(function () {
        if (document.forms["sensorType"]["Sensor"].value == "Add Sensor") {
            addMultipleToGraph();
        } else {
            addToGraph(document.forms["sensorType"]["Sensor"]);
        }
    });
});

$(function () {
    $('#buttonClear').click(function () {
        initializeGraph();
    });
});

$(function () {
    initializeGraph();
});

</script>

<form name="sensorType">
<p>
    <select name="Sensor Type" onChange="populateSensors(this, Sensor);">
        <option>Select Sensor Type</option>
        <option>co2</option>
        <option>temperature</option>
        <option>humidity</option>
    </select>

    <select name="Sensor">  
        <option>Add Sensor</option>
    </select>
</p>
</form>

<button id="buttonGraph" class="autocompare">Graph</button>
<button id="buttonClear" class="autocompare">Clear</button>