<head>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>

  <!-- Date Range Picker http://www.daterangepicker.com/#ex4 -->
  <script src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
  <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
  <link rel="stylesheet" type="text/css" href="/../static/css/bootstrap.css" />
</head>

<script>

var gSensors;

function addToGraph(selectIn)
{
  var idx = selectIn.selectedIndex;
  var sensor = gSensors[idx-1];
  if (typeof sensor != "undefined")
  {
    var dateRange = formatDateRange(document.forms["dateRange"]["Date Range"].value);
    addSensor(sensor.controller_id, sensor.node_id, sensor.sensor_id, dateRange);
  }
}   

function populateSensors(selectIn, selectOut)
{
  var idx = selectIn.selectedIndex;
  var sensorType = selectIn[idx].text;
  {
    $.get("http://localhost:8000/api/sensors/" + sensorType, 
      function(data, status){
            fillSelect(data, selectOut)
    });
  }

  selectOut.selectedIndex = 0;
}

function fillSelect(jsonReply, selectOut)
{
  gSensors = jsonReply;
  var length = gSensors.length;

  selectOut.length = length + 1

  for (i= 0; i < length; i++)
  {
    selectOut[i+1].text = (gSensors[i].name);
  }
}

function formatData(serializerData) {
  formattedData = [];
  $.each(serializerData, function(key, value) {
    var date = new Date(value.created);
    formattedData.push([date.getTime(), parseFloat(value.payload)]);
  }); 
  return formattedData;
}

function formatDateRange(dates_str) {
  // convert from daterangepicker string to seconds since epoch
  var dates = dates_str.split(" - ");
  return Date.parse(dates[0])/1000 + "&" + Date.parse(dates[1])/1000;
}

function addSensor(controller, node, sensor, dateRange) {
  var chart = $('#chart').highcharts();

  $.getJSON( "http://localhost:8000/api/controllers/" + controller + "/nodes/" + node + "/sensors/" +
      sensor, function( sensorInfo ) {

    // check to avoid adding a series multiple times
    if (chart.get(sensorInfo["sensor_id"])) return;

    $.getJSON( "http://localhost:8000/api/controllers/" + controller + "/nodes/" + node + "/sensors/" +
      sensor + "/data/" + dateRange, function( data ) {
      var series = formatData(data);

      chart.addSeries({
        yAxis: sensorInfo["sensor_type"],
        name: sensorInfo["name"],
        id: sensorInfo["sensor_id"],
        data: series,
      });
    }); 
  });
}

// set initial chart options
function initializeGraph() {
  // display times in local timezone
  Highcharts.setOptions({
    global: {
      useUTC: false
    }
  })

  $('#chart').highcharts({
    chart: {
      type: 'line',
      zoomType: 'x',
      showAxes: true
    },

    title: {
      text: 'Sensor Data Over Time'
    },

    xAxis: {
      type: 'datetime'
    },

    yAxis: [{
      title: {
        text: "CO2 ppm"
      },
      id: "co2",
      opposite: false,
    }, {
      title: {
        text: "Temperature Â°C"
      },
      id: "temperature",
      opposite: true,
    }, {    
      title: {
        text: "Humidity %"
      },
      id: "humidity",
      opposite: true,         
    }],

    plotOptions: {
      series: {
        marker: {
          enabled: false
        },
        lineWidth: 4
      }
    },
  });
}

$(document).ready(function() {
  initializeGraph();

  $('input[name="Date Range"]').daterangepicker({
    ranges: {
       'Today': [moment(), moment()],
       'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
       'Last 7 Days': [moment().subtract(6, 'days'), moment()],
       'Last 30 Days': [moment().subtract(29, 'days'), moment()],
       'This Month': [moment().startOf('month'), moment().endOf('month')],
       'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
    },
    drops: "up",
    autoApply: true,
  });
});

</script>

<body>
  <br>

  <div id="chart" style="width:100%; height:400px;"></div>

  <form name="dateRange">
    <p>
      <input type="text" name="Date Range"/>
    </p>
  </form>

  <form name="sensorType">
    <p>
      <select name="Sensor Type" onChange="populateSensors(this, Sensor);">
        <option>Select Sensor Type</option>
        <option>co2</option>
        <option>temperature</option>
        <option>humidity</option>
      </select>

      <select name="Sensor" onChange="addToGraph(this);">  
        <option>Add Sensor</option>
      </select>
    </p>
  </form>

  <p>
    <button id="buttonClear" onclick="initializeGraph();">Clear</button>
  </p>
</body>